  service: todo-api
  provider:
    name: aws
    runtime: nodejs18.x
    region: eu-west-1
    deploymentBucket:
      name: todo-amir
    environment:
      TODOS_TABLE: ${env:TODOS_TABLE}
  resources:
    todos:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      UpdateReplacePolicy: Retain
      Properties:
        TableName: ${env:TODOS_TABLE}
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: status
            AttributeType: S
          - AttributeName: dueDate
            AttributeType: S
          - AttributeName: createdTime
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST
        GlobalSecondaryIndexes:
          - IndexName: StatusIndex
            KeySchema:
              - AttributeName: status
                KeyType: HASH
            Projection:
              ProjectionType: ALL
          - IndexName: DueDateIndex
            KeySchema:
              - AttributeName: dueDate
                KeyType: HASH
            Projection:
              ProjectionType: ALL
          - IndexName: CreatedTimeIndex
            KeySchema:
              - AttributeName: createdTime
                KeyType: HASH
            Projection:
              ProjectionType: ALL
  functions:
    createTodo:
      handler: src/handlers/createTodo.handler
      events:
        - http:
            path: todos
            method: post
      iamRoleStatements:
        - Effect: Allow
          Action:
            - dynamodb:PutItem
          Resource:
            - arn:aws:dynamodb:${self:provider.region}:*:table/${env:TODOS_TABLE}

    getTodos:
      handler: src/handlers/filterTodo.handler
      events:
        - http:
            path: todos
            method: get
            request:
              parameters:
                querystrings:
                  status: false
                  createdTime: false
                  dueDate: false
      iamRoleStatements:
        - Effect: Allow
          Action:
            - dynamodb:Query
          Resource:
            - arn:aws:dynamodb:${self:provider.region}:*:table/${env:TODOS_TABLE}
            - arn:aws:dynamodb:${self:provider.region}:*:table/${env:TODOS_TABLE}/index/*

    updateTodo:
      handler: src/handlers/updateTodo.handler
      events:
        - http:
            path: todos/{id}
            method: put
      iamRoleStatements:
        - Effect: Allow
          Action:
            - dynamodb:UpdateItem
          Resource:
            - arn:aws:dynamodb:${self:provider.region}:*:table/${env:TODOS_TABLE}

    deleteTodo:
      handler: src/handlers/deleteTodo.handler
      events:
        - http:
            path: todos/{id}
            method: delete
      iamRoleStatements:
        - Effect: Allow
          Action:
            - dynamodb:DeleteItem
          Resource:
            - arn:aws:dynamodb:${self:provider.region}:*:table/${env:TODOS_TABLE}
